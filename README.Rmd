---
title: "Introduction to using Rmarkdown for automated reports"
author: "Randy Johnson"
date: "`r format(Sys.Date(), '%d %B, %Y')`"
output: 
    word_document:
        fig_caption: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, dpi=300, fig.width=7, fig.height=3.25)
knitr::opts_knit$set(eval.after = 'fig.cap')

# if you like the Visual Markdown Editor, and you don't have a copy of RStudio 1.4+:
# https://blog.rstudio.com/2020/09/30/rstudio-v1-4-preview-visual-markdown-editing/

# load required packages
library(tools)
library(knitr)

library(dplyr)
library(readxl)

library(ggplot2)
library(cowplot) # see https://wilkelab.org/cowplot/articles/themes.html
library(gganimate)
library(gifski)
library(magick)

library(maps)

if(!require(sars2pack, quietly = TRUE))
{
    # function reference for the sars2pack:
    # https://seandavi.github.io/sars2pack/reference/index.html
    
    remotes::install_github('seandavi/sars2pack')
    library(sars2pack)
}


# set ggplot theme
theme_set(theme_half_open())


# load the data we will be looking at (save the data to make knitting quicker while developing the report - we will remove this later)
if(file.exists('dat.RData'))
{
    load('dat.RData')
}else{
    # world-wide data
    jhu <- jhu_data()
    
    # use this to convert state abbreviation to state name
    # (this comes from the datasets package)
    data(state)
    
    abb2name <- c('District of Columbia', state.name)
    names(abb2name) <- c('DC', state.abb)
    
    # state-level statistics
    us <- combined_us_cases_data() %>%
        filter(dataset == 'jhu') %>%          # use jhu data
        mutate(sname = abb2name[state]) %>%   # add full state name
        filter(!is.na(sname))                 # remove territories

    jhu_us <- filter(jhu, CountryRegion == 'US')


    # state population data (estimamte as of July 1, 2019)
    if(!file.exists('census.xlsx'))
        download.file("https://www2.census.gov/programs-surveys/popest/tables/2010-2019/state/totals/nst-est2019-01.xlsx", 'census.xlsx')

    census <- read_excel('census.xlsx', skip = 3) %>%
        rename(region = ...1, pop = `2019`) %>%
        mutate(region = gsub('.', '', region, fixed = TRUE)) %>%
        filter(!is.na(region)) %>%
        dplyr::select(region, pop)


    # map data for each state
    states <- st_as_sf(map("state", plot = FALSE, fill = TRUE)) %>%
        mutate(ID = toTitleCase(ID)) %>%
        left_join(us, by = c("ID" = "sname")) %>%
        left_join(census, by = c('ID' = 'region'))


    # calculate incidence rates
    states$ir <- NA
    s <- states$state[1]   # current state
    w <- rep(0, 7)         # for current weighted average

    for(i in 1:nrow(states))
    {
        # reset weighted average when switching to a new state
        if(s != states$state[i])
        {
            s <- states$state[i]
            w <- rep(0, 7)
        }
    
        # update incidence for the week
        w <- c(states$incidence[i], w[1:6])
    
        # calculate incidence rate per 100,000 people over the past week
        states$ir[i] <- mean(w, na.rm = TRUE) / states$pop[i] * 1e5
    }
    
    # save to disk
    save(jhu, us, jhu_us, states, file = 'dat.RData')
}

```

## Introduction

The purpose of this repository is to show off the benefit of using `knitr` and `Rmarkdown` to make automated reports, complete with figures, tables and mathematical equations. The report we will be creating in this demo consists of some COVID19 statistics (this is not meant to be a comprehensive review of COVID19 statistics). Due to the quickly changing nature of these statistics, we want to be able to update the report without having to copy and paste a bunch of tables and figures into a Word (or other) document every time we want to share it. Using `knitr` and `Rmarkdown` will make updating our report as simple as clicking a button.

## Rmarkdown document structure

### Header

Each Rmarkdown document has a short YAML header containing some metadata about the document. I'll only discuss the options we use in this document, but you can find a bunch of other document formats and options on the [RStudio Formats](https://rmarkdown.rstudio.com/formats.html) page. The only required option is `output`.

-   title: Title of the document

-   author: Name(s) of the author(s)

-   date: Whatever goes between the quote marks is what will be displayed as the document date. In our case we put an R command, `format(Sys.Date(), '%d %B, %Y)`, that uses the current date.

-   output: This defines the type of document that will be generated by our report. The outputs I most often generate are `md_document`, `pdf_document` and `word_document`.

### Setup code block

The setup code block is where you want to do any setup of your global environment that doesn't directly pertain to the document. This is where I set `knitr` options, load packages, pre-process my data, etc...

### Formatted text and code blocks

The rest of the document contains the formatted text and code blocks that generate the results, figures and tables that make up your report.

## COVID19 update

In this short report, we will be using the [sars2pack](https://seandavi.github.io/sars2pack/reference/index.html) package by [Sean Davis](https://github.com/seandavi) and several other [contributors](https://github.com/seandavi/sars2pack/graphs/contributors). As I mentioned above, this isn't a very good report, but it does allow us to cover the technical basics of how to work with R markdown. I'll also include a few other off-topic comments just for fun.

Lets start with a simple figure showing the cumulative number of cases in the US between the end of January and today (Figure 1), and then we'll take a look at the cumulative number of cases by state for one week ago (Figure 2).

```{r US total cases, fig.cap='Figure 1. Cumulative number of COVID19 cases in the US between Jan 22 and the present date'}

# See this tutorial for a general introduction to ggplot2:
# https://r-statistics.co/Complete-Ggplot2-Tutorial-Part1-With-R-Code.html


filter(jhu_us, subset == 'confirmed') %>%
    ggplot(aes(date, count/1e6)) +
    geom_line() +
    xlab('Date') +
    ylab('Millions of Cases')
```

```{r US cases last week, fig.cap=paste('Figure 2. Total number of confirmed COVID19 cases in the US by state as of', format(Sys.Date() - 7, '%B %d'))}

# see the following tutorials for some really cool stuff you can do with maps
# https://www.r-spatial.org/r/2018/10/25/ggplot2-sf.html
# https://www.r-spatial.org/r/2018/10/25/ggplot2-sf-2.html
# https://www.r-spatial.org/r/2018/10/25/ggplot2-sf-3.html

filter(states, date == Sys.Date() - 7) %>%
    ggplot() + 
    geom_sf(aes(fill = count)) +
    coord_sf(crs = st_crs(2163), xlim = c(-2500000, 2500000), ylim = c(-2300000, 
         730000), datum = NA)
```

Next lets look at the state with the highest number of average daily cases each month. Tables are fairly easy to add to an Rmd file with the `kable()` function in the `knitr` package.

```{r daily cases, message=FALSE}

    # add some nicer date formats - see this page for more on date formats:
    # https://campus.datacamp.com/courses/intermediate-r-for-finance/dates?ex=6
mutate(us,
       mo = format(date, '%Y-%m'),
       yr = format(date, '%Y'),
       mo.pretty = format(date, '%B')) %>%
    
    # average monthly incidence
    group_by(sname, mo, yr, mo.pretty) %>%
    summarize(incidence = (max(count) - min(count)) / length(count)) %>%
    ungroup() %>%
    
    # state with highest average daily incidence
    group_by(mo, yr, mo.pretty) %>%
    summarize(state = sname[which.max(incidence)],
              incidence = round(max(incidence), 1)) %>%
    ungroup() %>%
    
    # drop yr-month label
    dplyr::select(-mo) %>%
    
    # print table
    kable(col.names = c('Year', 'Month', 'State', 'Incidence'),
          caption = "Table 1. States with the highest average daily incidence (confirmed cases) for each month.")
```

### Compare raw incidence with incidence rates

Up until now we have shown raw counts and incidence, but in this section we will compare these statistics with incidence rates normalize by the population of each state. We have also removed some of the day-to-day variability by calculating a running 7-day average of the incidence rate.

```{r raw incidence, fig.cap=paste("Figure 3. Number of confirmed daily cases in Marylyand, DC and Virginia between January 22 and", format(Sys.Date() - 7, '%B %d')), warning=FALSE}

filter(states, state %in% c('MD', 'DC', 'VA')) %>%
    ggplot(aes(date, incidence, color = state)) +
    geom_line() +
    xlab('Date') +
    ylab('Raw Daily Incidence')
```

The total numbers make DC look pretty good in the previous figure. It is important to note, however, that the population of DC is much smaller and denser than Maryland or Virginia. What does this look like if we normalize by population size?

```{r incidence rate, fig.cap=paste("Figure 4. Incidence rate (confirmed cases) per 100,000 individuals averaged over the past seven days in Maryland, DC and Virginia between January 22 and", format(Sys.Date() - 7, '%B %d')), warning=FALSE}

filter(states, state %in% c('MD', 'DC', 'VA')) %>%
    ggplot(aes(date, ir, color = state)) +
    geom_line() +
    xlab('Date') +
    ylab('Incidence Rate per 100,000')
```

### A cool video

In this subsection we will display a video showing the incidence rate across the country over time. In the coding demo, we'll build this up in 4 steps as follows:

-   We'll start by modifying the code from Figure 2 to display incidence rates.

-   Next we'll use the `gganimate` package to create an animated gif showing the change in incidence rates in the US over the course of the pandemic.

-   We'll create a date sidebar to show the progression of time throughout the animation.

-   Lastly, we'll use the `magick` package to append the two animated gifs together into a single gif.

```{r incidence rate video, fig.cap=paste("Figure 5. Seven-day average incidence rate (confirmed cases) per 100,000 individuals for each of the lower 48 states between January 22 and", format(Sys.Date() - 7, '%B %d'))}

# See the following tutorials for more information on using the gganimate package:
# https://www.datanovia.com/en/blog/gganimate-how-to-create-plots-with-beautiful-animation-in-r
# https://d4tagirl.com/2017/05/how-to-plot-animated-maps-with-gganimate
# https://github.com/thomasp85/gganimate/wiki/Animation-Composition

# number of frames
nf <- length(unique(states$date))

# lower 48 states
p <- #    filter(states, date == '2020-05-24') %>% ggplot() +
    ggplot(states) +
    geom_sf(aes(fill = ir)) +
    coord_sf(crs = st_crs(2163), xlim = c(-2500000, 2500000), ylim = c(-2300000, 
             730000), datum = NA) +
    transition_manual(date) +
    scale_fill_gradientn(colors = c("#132B43",
                                    "#56B1F7",
                                    "#93f755"),
                         values = c(0, 0.25, 1),
                         na.value = "#132B43",
                         name = 'IR')

p_gif <- animate(p, nframes = nf, fps = 10, width = 600, height = 500,
                 renderer = gifski_renderer()) %>%
    image_read()


# date sidebar
d <- #    filter(states, date == '2020-05-24') %>% ggplot(aes(1, date)) +
    
    ggplot(states, aes(1, date)) +
    geom_point(size = 2) +
    ylab('') +
    coord_cartesian(xlim = c(1, 1.1), ylim = range(states$date), clip = 'off') +
    transition_manual(date) +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.line.x = element_blank(),
          plot.margin = margin(t = 4, b = 4, unit = 'cm'))

d_gif <- animate(d, nframes = nf, fps = 10, width = 50, height = 500,
                 renderer = gifski_renderer()) %>%
    image_read()


# add sidebar onto figure
fig <- image_append(c(d_gif[1], p_gif[1]))

for(i in 2:nf)
    fig <- c(fig, image_append(c(d_gif[i], p_gif[i])))
    
fig
```

Now that we have the Rmd file set up, all we have to do is knit the document and our code will fetch new results, generate new figures and tables, and put them all together in a new document. You can check out the repository to review the code [here](https://github.com/Bioinformatics-User-Forum/Automated-Reports-Presentation). If you do, you'll also see the same report knitted as a markdown file. All it takes to knit an Rmd file into a different format is the modification of a few lines in the yaml header - usually. There are some format specific things you can do that won't gracefully translate over to other formats.
